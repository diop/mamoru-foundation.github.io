# WASM Daemon Development

WASM Daemons allow you to define incident matching logic using any language that can be compiled to WebAssembly.
Currently, only [AssemblyScript](https://www.assemblyscript.org/) is supported.
You can write a custom code against a blockchain context, decide when to emit an incident, customize message, severity, etc.

1. [Prerequisite](#prerequisite)
    1. [Setup environment](#setup-environment)
    2. [Define contract for monitoring](#define-contract-for-monitoring)
2. [Creating a Daemon](#creating-a-daemon)
3. [Testing](#testing)
4. [Deploying](#deploying)

After a few minutes, Mamoru Sniffers will fetch your daemon and start running your daemon against blockchain transactions.

## Pre-requisites
+ NodeJS
+ AssemblyScript

### Using NPM

```jsx
npm install -g mamoru-cli
```

### Using Yarn

```jsx
yarn global add mamoru-cli
```

## Upgrading

To upgrade the global Mamoru-CLI package, run:

### Using NPM

```jsx
npm update -g mamoru-cli
```

### Using Yarn

```jsx
yarn global upgrade --latest mamoru-cli
```

## Creating a WASM Daemon

To create a new WASM project, run:
```jsx
mamoru-cli init my-new-daemon --type wasm --chain SUI_TESTNET
```

 `cd` into `my-new-daemons` and run the following commands:
 ```shell
npm install --save-dev assemblyscript@0.26.3
npx asinit .
 ```

### Compile the code into WebAssembly binary
```shell
npx asc ./assembly/index.ts --target release --exportRuntime
```
You'll see a file `./build/release.wasm` that is the compiled daemon in WebAssembly format.

### Testing
Testing are not implemented for daemons yet.
However, WASM daemons are validated during deploying phase.
You will receive an error message if your WASM module is invalid, some types are incompatible etc.

### Deploying
```shell
export DAEMON_BINARY=$(cat ./build/release.wasm | base64)

# TODO: the command is not valid yet, as per changes in `validation-chaind`
validation-chaind tx \
  validationchain register-daemon "{\"content\": \"${DAEMON_BINARY}\", \"chain\": {\"chain_type\": 4}}" \
  --from wasm-daemon-guide \
  --node https://validation-chain.testnet.mamoru.foundation:26657 \
  --chain-id validationchaintestnet
```

